<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Semsira 证件合成工具</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        @font-face {
            font-family: 'SemsiraFont';
            src: url('semsira.ttf');
        }
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .controls { background: #333; padding: 20px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 900px; }
        .input-item { display: flex; flex-direction: column; }
        label { font-size: 12px; color: #aaa; }
        input { padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
        button { grid-column: span 2; padding: 15px; background: #e67e22; border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #d35400; }
        canvas { margin-top: 20px; border: 5px solid #444; max-width: 100%; height: auto; background: white; }
    </style>
</head>
<body>

    <h2>SMK Syed Sirajuddin 图像合成系统</h2>

    <div class="controls">
        <div class="input-item"><label>1. 头像照片</label><input type="file" id="img1"></div>
        <div class="input-item"><label>2. 汽车正面 (1:1)</label><input type="file" id="img2"></div>
        <div class="input-item"><label>3. 汽车侧面 (1:1)</label><input type="file" id="img3"></div>
        <div class="input-item"><label>4. 汽车背面 (1:1)</label><input type="file" id="img4"></div>
        <div class="input-item"><label>5. 驾照正面</label><input type="file" id="img5"></div>
        <div class="input-item"><label>6. 驾照背面</label><input type="file" id="img6"></div>
        <div class="input-item"><label>7. 路税照片</label><input type="file" id="img7"></div>
        <div class="input-item"><label>8. 导出文件名</label><input type="text" id="fileName" value="SMKSS_Output"></div>
        <button onclick="generate()">生成并导出最终图像</button>
    </div>

    <canvas id="mainCanvas"></canvas>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const W = 1000;
    const H = 1400;
    canvas.width = W;
    canvas.height = H;

    async function generate() {
        // 加载必要资源
        await document.fonts.load("1em SemsiraFont");
        const logoSemsira = await loadImage('semsira.png');
        const logoSS6 = await loadImage('ss6.png');

        // 1. 绘制橘黄渐变背景
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#FFB347");
        grad.addColorStop(1, "#FFCC33");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, W, H);

        // 2. 绘制左上角 Logo (semsira.png)
        ctx.drawImage(logoSemsira, 30, 30, 100, 100);

        // 3. 绘制照片模块 (x, y, w, h, radius)
        // 右侧大型证件
        await drawSmartImage('img1', 30, 30, 240, 220, 15);  // 虽然左上角有Logo，但按你要求头像通常在Logo旁或下方
        await drawSmartImage('img5', 290, 30, 680, 310, 20); 
        await drawSmartImage('img6', 290, 360, 680, 310, 20); 
        await drawSmartImage('img7', 290, 690, 680, 280, 20); 

        // 左侧汽车三连图
        await drawSmartImage('img2', 30, 270, 240, 240, 15);
        await drawSmartImage('img3', 30, 530, 240, 240, 15);
        await drawSmartImage('img4', 30, 790, 240, 240, 15);

        // 4. 在汽车背面图(img4)下方绘制双 Logo
        // 位置计算：img4 的 y 是 790，h 是 240，所以下方起始于 1030
        ctx.drawImage(logoSemsira, 45, 1050, 100, 100);
        ctx.drawImage(logoSS6, 155, 1050, 100, 100);

        // 5. 绘制底部文字
        ctx.fillStyle = "black";
        ctx.font = "34px 'SemsiraFont'";
        ctx.textAlign = "center";
        ctx.fillText("SEKOLAH MENENGAH KEBANGSAAN SYED SIRAJUDDIN", W/2, H - 60);

        exportImage();
    }

    // 辅助：加载静态图片
    function loadImage(src) {
        return new Promise(res => {
            const img = new Image();
            img.onload = () => res(img);
            img.src = src;
        });
    }

    // 核心绘制逻辑：带边框、圆角、等比缩放
    async function drawSmartImage(inputId, x, y, w, h, r) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return;

        const img = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const tempImg = new Image();
                tempImg.onload = () => res(tempImg);
                tempImg.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        ctx.save();
        // 绘制 3px 黑色边框
        ctx.beginPath();
        drawRoundedRectPath(ctx, x - 3, y - 3, w + 6, h + 6, r + 3);
        ctx.fillStyle = "black";
        ctx.fill();

        // 裁剪圆角矩形
        ctx.beginPath();
        drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip();

        // Object-fit: cover 算法
        const imgRatio = img.width / img.height;
        const targetRatio = w / h;
        let dW, dH, dX, dY;
        if (imgRatio > targetRatio) {
            dH = h; dW = h * imgRatio;
            dX = x - (dW - w) / 2; dY = y;
        } else {
            dW = w; dH = w / imgRatio;
            dX = x; dY = y - (dH - h) / 2;
        }
        ctx.drawImage(img, dX, dY, dW, dH);
        ctx.restore();
    }

    function drawRoundedRectPath(c, x, y, w, h, r) {
        c.moveTo(x + r, y);
        c.arcTo(x + w, y, x + w, y + h, r);
        c.arcTo(x + w, y + h, x, y + h, r);
        c.arcTo(x, y + h, x, y, r);
        c.arcTo(x, y, x + w, y, r);
        c.closePath();
    }

    function exportImage() {
        const name = document.getElementById('fileName').value || 'SMKSS_Result';
        const link = document.createElement('a');
        link.download = name + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
</script>
</body>
</html>
