<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SMKSS HD Synthesis System</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        @font-face { font-family: 'SemsiraFont'; src: url('semsira.ttf'); }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #0f0f0f; color: #eee; margin: 0; height: 100vh; overflow: hidden;
        }

        /* 全屏拖拽遮罩提示 */
        #drop-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(230, 126, 34, 0.2); border: 8px dashed #e67e22; z-index: 9999;
            justify-content: center; align-items: center; pointer-events: none;
        }
        #drop-overlay h1 { color: #e67e22; font-size: 3rem; background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 15px; }

        .main-container { display: flex; height: 100vh; width: 100vw; }

        /* 左侧面板优化 */
        .left-panel {
            width: 420px; background: #181818; padding: 25px; overflow-y: auto;
            border-right: 1px solid #222; box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        .left-panel::-webkit-scrollbar { width: 6px; }
        .left-panel::-webkit-scrollbar-track { background: #111; }
        .left-panel::-webkit-scrollbar-thumb { background: #e67e22; border-radius: 10px; }

        /* Dashboard 头部 Logo 样式 */
        .dashboard-header {
            display: flex; align-items: center; gap: 15px;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #222;
        }
        .mini-logo {
            width: 50px; height: 50px; filter: drop-shadow(0 0 5px rgba(230, 126, 34, 0.4));
        }
        .dashboard-header h2 { 
            font-size: 22px; color: #ff8c00; margin: 0; font-weight: 800; letter-spacing: 1px;
        }

        .controls { display: grid; gap: 14px; }
        .input-item { 
            display: flex; flex-direction: column; padding: 12px; border: 1px solid #333; 
            border-radius: 10px; background: #222; transition: all 0.2s ease;
        }
        .input-item.drag-over { 
            border-color: #ff8c00 !important; 
            background: rgba(255, 140, 0, 0.1) !important;
            border-style: dashed !important;
        }

        label { font-size: 11px; color: #ff8c00; margin-bottom: 6px; font-weight: bold; text-transform: uppercase; }
        input[type="file"] { color: #777; font-size: 11px; cursor: pointer; }
        input[type="text"] { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #111; color: white; outline: none; }
        
        .button-group { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
        button { 
            width: 100%; padding: 16px; border: none; color: white; font-weight: bold; 
            border-radius: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .btn-generate { background: #e67e22; }
        .btn-generate:hover { background: #d35400; transform: translateY(-2px); }
        .btn-download { background: #27ae60; }
        .btn-download:disabled { background: #333; color: #555; }
        
        .right-panel { flex: 1; display: flex; align-items: center; justify-content: center; background: #0f0f0f; padding: 20px; }
        canvas { border: 2px dashed #444; box-shadow: 0 20px 60px rgba(0,0,0,1); max-width: 95%; max-height: 92vh; object-fit: contain; }
        .status-bar { font-size: 10px; color: #444; margin-top: 15px; text-align: center; }
    </style>
</head>
<body oncontextmenu="return false">

    <div id="drop-overlay">
        <h1>DROP IMAGE HERE</h1>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="dashboard-header">
                <img src="semsira.png" alt="Logo" class="mini-logo">
                <h2>DASHBOARD</h2>
            </div>

            <div class="controls">
                <div class="input-item"><label>1. Profile Photo</label><input type="file" id="img1" accept="image/*"></div>
                <div class="input-item"><label>2. Vehicle Front (1:1)</label><input type="file" id="img2" accept="image/*"></div>
                <div class="input-item"><label>3. Vehicle Side (1:1)</label><input type="file" id="img3" accept="image/*"></div>
                <div class="input-item"><label>4. Vehicle Rear (1:1)</label><input type="file" id="img4" accept="image/*"></div>
                <div class="input-item"><label>5. Driving License (Front)</label><input type="file" id="img5" accept="image/*"></div>
                <div class="input-item"><label>6. Driving License (Rear)</label><input type="file" id="img6" accept="image/*"></div>
                <div class="input-item"><label>7. Road Tax Photo</label><input type="file" id="img7" accept="image/*"></div>
                <div class="input-item"><label>8. IC Number (Filename)</label><input type="text" id="fileName" placeholder="Enter IC..."></div>
            </div>
            <div class="button-group">
                <button class="btn-generate" onclick="handleGenerate()">Render Preview</button>
                <button class="btn-download" id="downloadBtn" onclick="exportImage()" disabled>Download Image</button>
            </div>
            <div class="status-bar">Secure Mode Active | 300 DPI Rendering</div>
        </div>

        <div class="right-panel">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

<script>
    // --- 权限检查 ---
    (function() {
        if (sessionStorage.getItem('access_granted') !== 'true') {
            window.location.replace('index.html');
        }
        document.onkeydown = function(e) {
            if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && e.keyCode === 73)) return false;
        };
        setInterval(function() { (function() {}.constructor("debugger")()); }, 100);
    })();

    // --- 拖拽交互优化 ---
    const overlay = document.getElementById('drop-overlay');
    
    // 全屏感知显示
    window.addEventListener('dragenter', (e) => { 
        e.preventDefault(); 
        overlay.style.display = 'flex'; 
    });
    
    // 隐藏遮罩逻辑
    window.addEventListener('dragover', (e) => { e.preventDefault(); });
    overlay.addEventListener('dragleave', (e) => { overlay.style.display = 'none'; });
    window.addEventListener('drop', (e) => { e.preventDefault(); overlay.style.display = 'none'; });

    // 输入框局部高亮
    document.querySelectorAll('.input-item').forEach(item => {
        const input = item.querySelector('input[type="file"]');
        item.addEventListener('dragover', (e) => { item.classList.add('drag-over'); });
        item.addEventListener('dragleave', () => { item.classList.remove('drag-over'); });
        item.addEventListener('drop', (e) => {
            item.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; }
        });
    });

    // --- Canvas 渲染引擎 ---
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const W = 2480, H = 3508;
    canvas.width = W; canvas.height = H;

    function initCanvas() {
        ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = "#333"; ctx.font = "italic 80px sans-serif"; ctx.textAlign = "center";
        ctx.fillText("READY FOR RENDERING...", W/2, H/2);
    }
    initCanvas();

    async function handleGenerate() {
        const btn = event.target;
        btn.disabled = true; btn.innerText = "SYNTHESIZING...";
        try {
            await generate();
            document.getElementById('downloadBtn').disabled = false;
        } catch (err) { alert(err); }
        finally { btn.disabled = false; btn.innerText = "REFRESH PREVIEW"; }
    }

    async function generate() {
        await document.fonts.load("1em SemsiraFont");
        const logoSemsira = await loadImage('semsira.png');
        const logoSS6 = await loadImage('ss6.png');

        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#FFB347"); grad.addColorStop(1, "#FFCC33");
        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

        await drawSmartImage('img1', 75, 75, 600, 660, 40);
        await drawSmartImage('img2', 75, 785, 600, 600, 40);
        await drawSmartImage('img3', 75, 1435, 600, 600, 40);
        await drawSmartImage('img4', 75, 2085, 600, 600, 40);

        const rightX = 725, rightWidth = 1680, spacing = 60;
        const h5 = await drawAdaptiveImage('img5', rightX, 75, rightWidth, 40);
        const y6 = 75 + h5 + (h5 > 0 ? spacing : 0);
        const h6 = await drawAdaptiveImage('img6', rightX, y6, rightWidth, 40);
        const y7 = y6 + h6 + (h6 > 0 ? spacing : 0);
        const h7 = await drawAdaptiveImage('img7', rightX, y7, rightWidth, 40);

        const logoY = 2085 + 600 + 45; 
        ctx.drawImage(logoSemsira, 120, logoY, 230, 230);
        ctx.drawImage(logoSS6, 380, logoY, 230, 230);
        
        ctx.fillStyle = "black"; ctx.font = "85px 'SemsiraFont'"; ctx.textAlign = "center";
        ctx.fillText("SEKOLAH MENENGAH KEBANGSAAN SYED SIRAJUDDIN", W/2, 3445);
    }

    // --- 辅助绘图函数 ---
    async function drawAdaptiveImage(inputId, x, y, targetWidth, radius) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return 0;
        const img = await loadImageFromFile(file);
        const targetHeight = targetWidth * (img.height / img.width);
        renderImage(img, x, y, targetWidth, targetHeight, radius);
        return targetHeight;
    }
    async function drawSmartImage(inputId, x, y, w, h, r) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return;
        const img = await loadImageFromFile(file);
        renderSmart(img, x, y, w, h, r);
    }
    function renderImage(img, x, y, w, h, r) {
        ctx.save();
        ctx.beginPath(); drawRoundedRectPath(ctx, x-8, y-8, w+16, h+16, r+8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath(); drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip(); ctx.drawImage(img, x, y, w, h); ctx.restore();
    }
    function renderSmart(img, x, y, w, h, r) {
        ctx.save();
        ctx.beginPath(); drawRoundedRectPath(ctx, x-8, y-8, w+16, h+16, r+8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath(); drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip();
        const ratio = img.width / img.height;
        let dW, dH, dX, dY;
        if (ratio > (w/h)) { dH = h; dW = h * ratio; dX = x - (dW - w)/2; dY = y; }
        else { dW = w; dH = w / ratio; dX = x; dY = y - (dH - h)/2; }
        ctx.drawImage(img, dX, dY, dW, dH); ctx.restore();
    }
    function loadImageFromFile(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => { const t = new Image(); t.onload = () => res(t); t.src = e.target.result; };
            reader.readAsDataURL(file);
        });
    }
    function drawRoundedRectPath(c, x, y, w, h, r) {
        c.moveTo(x + r, y); c.arcTo(x + w, y, x + w, y + h, r); c.arcTo(x + w, y + h, x, y + h, r);
        c.arcTo(x, y + h, x, y, r); c.arcTo(x, y, x + w, y, r); c.closePath();
    }
    function loadImage(src) { return new Promise(res => { const img = new Image(); img.onload = () => res(img); img.src = src; img.onerror = () => res(new Image()); }); }
    function exportImage() {
        const icNum = document.getElementById('fileName').value.trim();
        const link = document.createElement('a');
        link.download = (icNum || 'SMKSS_Final') + '.png';
        link.href = canvas.toDataURL('image/png', 1.0); link.click();
    }
</script>
</body>
</html>
