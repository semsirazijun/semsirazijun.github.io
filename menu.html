<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SMKSS 高清合成系统 - 制作版</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        @font-face { font-family: 'SemsiraFont'; src: url('semsira.ttf'); }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #1a1a1a; 
            color: #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0;
        }

        h2 { color: #ff8c00; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .controls { 
            background: #2a2a2a; 
            padding: 25px; 
            border-radius: 16px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            width: 100%; 
            max-width: 900px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .input-item { 
            display: flex; 
            flex-direction: column; 
            padding: 12px; 
            border: 2px dashed #444; 
            border-radius: 10px; 
            transition: all 0.3s ease; 
            background: #222;
        }

        .input-item.drag-over { 
            border-color: #ff8c00; 
            background: rgba(255, 140, 0, 0.1); 
            transform: scale(1.02);
        }

        label { font-size: 13px; color: #ff8c00; margin-bottom: 8px; font-weight: bold; }
        
        input[type="file"] { color: #888; font-size: 12px; cursor: pointer; }
        
        input[type="text"] { 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #444; 
            background: #111; 
            color: white; 
            outline: none;
        }
        
        input[type="text"]:focus { border-color: #ff8c00; }

        .button-group { 
            grid-column: span 2; 
            display: flex; 
            gap: 15px; 
            margin-top: 15px; 
        }

        button { 
            flex: 1;
            padding: 16px; 
            border: none; 
            color: white; 
            font-weight: bold; 
            font-size: 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.2s;
        }

        .btn-generate { background: #e67e22; }
        .btn-generate:hover { background: #d35400; transform: translateY(-2px); }
        
        .btn-download { background: #27ae60; }
        .btn-download:hover { background: #219150; transform: translateY(-2px); }
        .btn-download:disabled { 
            background: #444 !important; 
            cursor: not-allowed; 
            transform: none !important;
            color: #777;
        }

        canvas { 
            margin-top: 30px; 
            border: 2px dashed #555; 
            border-radius: 12px;
            max-width: 100%; 
            height: auto; 
            background: #2a2a2a; /* 初始深色背景 */
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
    </style>
</head>
<body>

    <h2>SMKSS 高清图像合成系统</h2>

    <div class="controls">
        <div class="input-item" data-id="img1"><label>1. 头像照片</label><input type="file" id="img1" accept="image/*"></div>
        <div class="input-item" data-id="img2"><label>2. 汽车正面 (1:1)</label><input type="file" id="img2" accept="image/*"></div>
        <div class="input-item" data-id="img3"><label>3. 汽车侧面 (1:1)</label><input type="file" id="img3" accept="image/*"></div>
        <div class="input-item" data-id="img4"><label>4. 汽车背面 (1:1)</label><input type="file" id="img4" accept="image/*"></div>
        <div class="input-item" data-id="img5"><label>5. 驾照正面 (原图比例)</label><input type="file" id="img5" accept="image/*"></div>
        <div class="input-item" data-id="img6"><label>6. 驾照背面 (原图比例)</label><input type="file" id="img6" accept="image/*"></div>
        <div class="input-item" data-id="img7"><label>7. 路税照片 (原图比例)</label><input type="file" id="img7" accept="image/*"></div>
        <div class="input-item"><label>8. 导出文件名</label><input type="text" id="fileName" value="SMKSS_A4_Final"></div>
        
        <div class="button-group">
            <button class="btn-generate" onclick="handleGenerate()">生成预览图像</button>
            <button class="btn-download" id="downloadBtn" onclick="exportImage()" disabled>下载 A4 图像</button>
        </div>
    </div>

    <canvas id="mainCanvas"></canvas>

<script>
    // 权限检查
    if (sessionStorage.getItem('access_granted') !== 'true') { window.location.href = 'index.html'; }

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const W = 2480; const H = 3508;
    canvas.width = W; canvas.height = H;

    // 初始化画布提示文字
    function initCanvas() {
        ctx.fillStyle = "#2a2a2a";
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = "#555";
        ctx.font = "100px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("等待生成预览...", W/2, H/2);
    }
    initCanvas();

    // 拖拽逻辑
    document.querySelectorAll('.input-item').forEach(item => {
        const input = item.querySelector('input[type="file"]');
        item.addEventListener('dragover', (e) => { e.preventDefault(); item.classList.add('drag-over'); });
        item.addEventListener('dragleave', () => { item.classList.remove('drag-over'); });
        item.addEventListener('drop', (e) => {
            e.preventDefault(); item.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; }
        });
    });

    async function handleGenerate() {
        const btn = event.target;
        const dlBtn = document.getElementById('downloadBtn');
        
        btn.innerText = "正在合成高清图像...";
        btn.disabled = true;
        
        try {
            await generate();
            dlBtn.disabled = false;
            dlBtn.innerText = "下载图像 (" + (document.getElementById('fileName').value || 'Final') + ")";
            // 自动滚动到预览区
            canvas.scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
            alert("合成失败: " + err);
        } finally {
            btn.innerText = "重新生成预览";
            btn.disabled = false;
        }
    }

    async function generate() {
        // 加载资源
        await document.fonts.load("1em SemsiraFont");
        const logoSemsira = await loadImage('semsira.png');
        const logoSS6 = await loadImage('ss6.png');

        // 1. 背景绘制 (黄橘渐变)
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#FFB347"); 
        grad.addColorStop(1, "#FFCC33");
        ctx.fillStyle = grad; 
        ctx.fillRect(0, 0, W, H);

        // 2. 左侧模块绘制
        await drawSmartImage('img1', 75, 75, 600, 660, 40, 'cover');
        await drawSmartImage('img2', 75, 785, 600, 600, 40, 'cover');
        await drawSmartImage('img3', 75, 1435, 600, 600, 40, 'cover');
        const carBackY = 2085; 
        const carBackHeight = 600;
        await drawSmartImage('img4', 75, carBackY, 600, carBackHeight, 40, 'cover');

        // 3. 右侧模块绘制
        const rightX = 725;
        const rightWidth = 1680;
        const spacing = 60;
        const h5 = await drawAdaptiveImage('img5', rightX, 75, rightWidth, 40);
        const y6 = 75 + h5 + (h5 > 0 ? spacing : 0);
        const h6 = await drawAdaptiveImage('img6', rightX, y6, rightWidth, 40);
        const y7 = y6 + h6 + (h6 > 0 ? spacing : 0);
        const h7 = await drawAdaptiveImage('img7', rightX, y7, rightWidth, 40);

        // 4. Logo 绘制
        const logoY = carBackY + carBackHeight + 45; 
        ctx.drawImage(logoSemsira, 120, logoY, 230, 230);
        ctx.drawImage(logoSS6, 380, logoY, 230, 230);

        // 5. 底部文字
        const contentBottom = Math.max(y7 + h7, logoY + 230);
        const footerTextY = Math.max(contentBottom + 120, 3360);
        ctx.fillStyle = "black";
        ctx.font = "85px 'SemsiraFont'";
        ctx.textAlign = "center";
        ctx.fillText("SEKOLAH MENENGAH KEBANGSAAN SYED SIRAJUDDIN", W/2, footerTextY);
    }

    // --- 辅助绘图函数 ---
    async function drawAdaptiveImage(inputId, x, y, targetWidth, radius) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return 0;
        const img = await loadImageFromFile(file);
        const ratio = img.height / img.width;
        const targetHeight = targetWidth * ratio;
        ctx.save();
        ctx.beginPath();
        drawRoundedRectPath(ctx, x - 8, y - 8, targetWidth + 16, targetHeight + 16, radius + 8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath();
        drawRoundedRectPath(ctx, x, y, targetWidth, targetHeight, radius);
        ctx.clip();
        ctx.drawImage(img, x, y, targetWidth, targetHeight);
        ctx.restore();
        return targetHeight;
    }

    async function drawSmartImage(inputId, x, y, w, h, r, mode) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return;
        const img = await loadImageFromFile(file);
        ctx.save();
        ctx.beginPath();
        drawRoundedRectPath(ctx, x - 8, y - 8, w + 16, h + 16, r + 8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath();
        drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip();
        const imgRatio = img.width / img.height;
        const targetRatio = w / h;
        let dW, dH, dX, dY;
        if (imgRatio > targetRatio) { dH = h; dW = h * imgRatio; dX = x - (dW - w) / 2; dY = y; }
        else { dW = w; dH = w / imgRatio; dX = x; dY = y - (dH - h) / 2; }
        ctx.drawImage(img, dX, dY, dW, dH);
        ctx.restore();
    }

    function loadImageFromFile(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => { 
                const t = new Image(); 
                t.onload = () => res(t); 
                t.src = e.target.result; 
            };
            reader.readAsDataURL(file);
        });
    }

    function drawRoundedRectPath(c, x, y, w, h, r) {
        c.moveTo(x + r, y); 
        c.arcTo(x + w, y, x + w, y + h, r); 
        c.arcTo(x + w, y + h, x, y + h, r); 
        c.arcTo(x, y + h, x, y, r); 
        c.arcTo(x, y, x + w, y, r); 
        c.closePath();
    }

    function loadImage(src) { 
        return new Promise(res => { 
            const img = new Image(); 
            img.onload = () => res(img); 
            img.src = src; 
            img.onerror = () => { console.log(src + " 加载失败，跳过"); res(new Image()); };
        }); 
    }

    function exportImage() {
        const name = document.getElementById('fileName').value || 'SMKSS_Final';
        const link = document.createElement('a');
        link.download = name + '.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }
</script>
</body>
</html>
