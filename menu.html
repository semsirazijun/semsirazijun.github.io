<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SMKSS 高清合成工作台</title>
    <link rel="icon" type="image/png" href="semsira.png">
    <style>
        @font-face { font-family: 'SemsiraFont'; src: url('semsira.ttf'); }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #121212; 
            color: #eee; 
            margin: 0;
            height: 100vh;
            overflow: hidden; /* 防止整页滚动 */
        }

        /* 主容器左右布局 */
        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* 左侧：控制面板 */
        .left-panel {
            width: 450px;
            background: #1e1e1e;
            padding: 20px;
            overflow-y: auto; /* 只有这一块可以滚动 */
            border-right: 1px solid #333;
            box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* 右侧：预览面板 */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #121212;
            padding: 20px;
            position: relative;
        }

        h2 { font-size: 20px; color: #ff8c00; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 15px; }

        .controls { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 12px; 
        }

        .input-item { 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            border: 1px dashed #444; 
            border-radius: 8px; 
            background: #252525;
            transition: 0.3s;
        }

        .input-item.drag-over { border-color: #ff8c00; background: rgba(255, 140, 0, 0.1); }
        
        label { font-size: 12px; color: #ff8c00; margin-bottom: 5px; font-weight: bold; }
        input[type="file"] { color: #888; font-size: 11px; }
        input[type="text"] { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #111; color: white; }

        .button-group { 
            margin-top: 20px;
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }

        button { 
            width: 100%;
            padding: 14px; 
            border: none; 
            color: white; 
            font-weight: bold; 
            font-size: 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s;
        }

        .btn-generate { background: #e67e22; }
        .btn-generate:hover { background: #d35400; }
        
        .btn-download { background: #27ae60; }
        .btn-download:disabled { background: #444; color: #777; cursor: not-allowed; }

        /* Canvas 预览区域自适应缩放 */
        .canvas-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas { 
            border: 1px solid #444; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #2a2a2a;
            max-width: 95%;   /* 宽度不超过容器 */
            max-height: 90vh; /* 高度不超过视口的 90% */
            object-fit: contain; /* 保持比例 */
        }

        .status-bar { font-size: 11px; color: #666; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="left-panel">
            <h2>SMKSS 合成工作台</h2>
            <div class="controls">
                <div class="input-item" data-id="img1"><label>1. 头像照片</label><input type="file" id="img1" accept="image/*"></div>
                <div class="input-item" data-id="img2"><label>2. 汽车正面 (1:1)</label><input type="file" id="img2" accept="image/*"></div>
                <div class="input-item" data-id="img3"><label>3. 汽车侧面 (1:1)</label><input type="file" id="img3" accept="image/*"></div>
                <div class="input-item" data-id="img4"><label>4. 汽车背面 (1:1)</label><input type="file" id="img4" accept="image/*"></div>
                <div class="input-item" data-id="img5"><label>5. 驾照正面</label><input type="file" id="img5" accept="image/*"></div>
                <div class="input-item" data-id="img6"><label>6. 驾照背面</label><input type="file" id="img6" accept="image/*"></div>
                <div class="input-item" data-id="img7"><label>7. 路税照片</label><input type="file" id="img7" accept="image/*"></div>
                <div class="input-item"><label>8. 导出文件名</label><input type="text" id="fileName" value="SMKSS_Final"></div>
            </div>

            <div class="button-group">
                <button class="btn-generate" onclick="handleGenerate()">生成高清预览</button>
                <button class="btn-download" id="downloadBtn" onclick="exportImage()" disabled>下载 A4 图像</button>
            </div>
            <div class="status-bar">系统准备就绪 | 300 DPI 高清模式</div>
        </div>

        <div class="right-panel">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
        </div>
    </div>

<script>
    if (sessionStorage.getItem('access_granted') !== 'true') { window.location.href = 'index.html'; }

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const W = 2480; const H = 3508;
    canvas.width = W; canvas.height = H;

    function initCanvas() {
        ctx.fillStyle = "#2a2a2a";
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = "#444";
        ctx.font = "100px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("预览区域 (等待生成)", W/2, H/2);
    }
    initCanvas();

    // 拖拽上传支持
    document.querySelectorAll('.input-item').forEach(item => {
        const input = item.querySelector('input[type="file"]');
        item.addEventListener('dragover', (e) => { e.preventDefault(); item.classList.add('drag-over'); });
        item.addEventListener('dragleave', () => { item.classList.remove('drag-over'); });
        item.addEventListener('drop', (e) => {
            e.preventDefault(); item.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) { input.files = e.dataTransfer.files; }
        });
    });

    async function handleGenerate() {
        const btn = event.target;
        const dlBtn = document.getElementById('downloadBtn');
        btn.disabled = true; btn.innerText = "正在合成图像...";
        
        try {
            await generate();
            dlBtn.disabled = false;
        } catch (err) {
            alert("错误: " + err);
        } finally {
            btn.disabled = false; btn.innerText = "更新预览图像";
        }
    }

    async function generate() {
        await document.fonts.load("1em SemsiraFont");
        const logoSemsira = await loadImage('semsira.png');
        const logoSS6 = await loadImage('ss6.png');

        // 背景
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, "#FFB347"); grad.addColorStop(1, "#FFCC33");
        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

        // 左侧模块 (img1-4)
        await drawSmartImage('img1', 75, 75, 600, 660, 40);
        await drawSmartImage('img2', 75, 785, 600, 600, 40);
        await drawSmartImage('img3', 75, 1435, 600, 600, 40);
        await drawSmartImage('img4', 75, 2085, 600, 600, 40);

        // 右侧模块 (img5-7)
        const rightX = 725, rightWidth = 1680, spacing = 60;
        const h5 = await drawAdaptiveImage('img5', rightX, 75, rightWidth, 40);
        const y6 = 75 + h5 + (h5 > 0 ? spacing : 0);
        const h6 = await drawAdaptiveImage('img6', rightX, y6, rightWidth, 40);
        const y7 = y6 + h6 + (h6 > 0 ? spacing : 0);
        const h7 = await drawAdaptiveImage('img7', rightX, y7, rightWidth, 40);

        // Logo & Footer
        const logoY = 2085 + 600 + 45; 
        ctx.drawImage(logoSemsira, 120, logoY, 230, 230);
        ctx.drawImage(logoSS6, 380, logoY, 230, 230);
        
        ctx.fillStyle = "black";
        ctx.font = "85px 'SemsiraFont'";
        ctx.textAlign = "center";
        ctx.fillText("SEKOLAH MENENGAH KEBANGSAAN SYED SIRAJUDDIN", W/2, 3420);
    }

    // 辅助函数 (保持不变但确保逻辑一致)
    async function drawAdaptiveImage(inputId, x, y, targetWidth, radius) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return 0;
        const img = await loadImageFromFile(file);
        const targetHeight = targetWidth * (img.height / img.width);
        renderImage(img, x, y, targetWidth, targetHeight, radius);
        return targetHeight;
    }

    async function drawSmartImage(inputId, x, y, w, h, r) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return;
        const img = await loadImageFromFile(file);
        renderSmart(img, x, y, w, h, r);
    }

    function renderImage(img, x, y, w, h, r) {
        ctx.save();
        ctx.beginPath(); drawRoundedRectPath(ctx, x-8, y-8, w+16, h+16, r+8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath(); drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip();
        ctx.drawImage(img, x, y, w, h);
        ctx.restore();
    }

    function renderSmart(img, x, y, w, h, r) {
        ctx.save();
        ctx.beginPath(); drawRoundedRectPath(ctx, x-8, y-8, w+16, h+16, r+8);
        ctx.fillStyle = "black"; ctx.fill();
        ctx.beginPath(); drawRoundedRectPath(ctx, x, y, w, h, r);
        ctx.clip();
        const ratio = img.width / img.height;
        let dW, dH, dX, dY;
        if (ratio > (w/h)) { dH = h; dW = h * ratio; dX = x - (dW - w)/2; dY = y; }
        else { dW = w; dH = w / ratio; dX = x; dY = y - (dH - h)/2; }
        ctx.drawImage(img, dX, dY, dW, dH);
        ctx.restore();
    }

    function loadImageFromFile(file) {
        return new Promise(res => {
            const reader = new FileReader();
            reader.onload = (e) => { const t = new Image(); t.onload = () => res(t); t.src = e.target.result; };
            reader.readAsDataURL(file);
        });
    }

    function drawRoundedRectPath(c, x, y, w, h, r) {
        c.moveTo(x + r, y); c.arcTo(x + w, y, x + w, y + h, r); c.arcTo(x + w, y + h, x, y + h, r);
        c.arcTo(x, y + h, x, y, r); c.arcTo(x, y, x + w, y, r); c.closePath();
    }

    function loadImage(src) { return new Promise(res => { const img = new Image(); img.onload = () => res(img); img.src = src; img.onerror = () => res(new Image()); }); }

    function exportImage() {
        const name = document.getElementById('fileName').value || 'Final';
        const link = document.createElement('a');
        link.download = name + '.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }
</script>
</body>
</html>
